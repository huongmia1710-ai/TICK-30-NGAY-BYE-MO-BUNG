<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>30 NG√ÄY BYE BYE M·ª† B·ª§NG</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --p1:#ff8fab; --p2:#ffb3c1; --p3:#ffd6a5; --p4:#9adbb3; --p5:#a5b4fc; --p6:#fecdd3;
    --bg:#fff7fb; --bg-grad:#fff0f6;
    --text:#2b2b2b; --muted:#6b7280;
    --card:#ffffff; --border:#f4dbe3;
  }
  body{margin:0;font-family:Inter,system-ui;background:linear-gradient(180deg,var(--bg-grad) 0%, #fff 40%);}
  .wrap{max-width:1200px;margin:28px auto;padding:0 18px}
  .hero{border:1px solid var(--border);border-radius:18px;padding:22px;
        background:linear-gradient(135deg,#fff0f6 0%,#fff 45%,#fff5f0 100%);
        box-shadow:0 12px 28px rgba(255,168,186,.20);}
  .hero h1{margin:0;font-size:30px}
  .subtitle{margin-top:6px;color:var(--muted);font-size:16px}

  .panel{margin-top:18px;border:1px solid var(--border);border-radius:12px;background:#fff;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff}
  .chip .name{font-weight:600}
  .chip button{border:none;background:transparent;cursor:pointer;font-size:14px}
  .chip .colordot{width:10px;height:10px;border-radius:999px;display:inline-block}

  .toast{position:fixed;right:16px;bottom:16px;background:#fff;
        border:1px solid var(--border);padding:12px 14px;border-radius:12px;
        box-shadow:0 12px 30px rgba(0,0,0,.12);display:none;font-weight:600;z-index:1000}
  .toast.show{display:block;animation:fade .18s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:999}

  table{border-collapse:collapse;margin-top:16px;width:100%}
  th,td{padding:8px 12px;border:1px solid #eee;text-align:center;position:relative}
  td.daycell.done{background:#ffeef3}
  .tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
           background:#333;color:#fff;padding:6px 8px;border-radius:6px;
           white-space:pre-line;font-size:12px;display:none;z-index:10}
  td:hover .tooltip{display:block}

  #journalModal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;
                align-items:center;justify-content:center;z-index:100}
  #journalForm{background:#fff;padding:20px;border-radius:12px;max-width:420px;width:92%}
  #journalForm input,#journalForm textarea{width:100%;margin:6px 0;padding:8px;border:1px solid #ccc;border-radius:6px}
  #journalForm .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="hero">
    <h1>30 NG√ÄY BYE BYE M·ª† B·ª§NG</h1>
    <div class="subtitle">ƒê·ª´ng ch·ªù ƒë·ªông l·ª±c m·ªõi b·∫Øt ƒë·∫ßu. H√£y b·∫Øt ƒë·∫ßu ƒë·ªÉ t·∫°o ra ƒë·ªông l·ª±c. üå∏</div>
  </div>

  <!-- üë• Qu·∫£n l√Ω th√†nh vi√™n -->
  <div class="panel">
    <div class="row" id="memberChips"></div>
    <div class="row" style="margin-top:10px">
      <input id="newMemberName" placeholder="T√™n th√†nh vi√™n m·ªõi" />
      <button id="addMemberBtn">‚ûï Th√™m th√†nh vi√™n</button>
      <span class="small">Th√™m/ƒë·ªïi t√™n/xo√° s·∫Ω t·ª± c·∫≠p nh·∫≠t ch·ªçn ng√†y, b·∫£ng tick, chart, leaderboard, journal.</span>
    </div>
  </div>

  <!-- üìÖ Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu -->
  <div class="panel">
    <div class="row">
      <label>Th√†nh vi√™n:</label>
      <select id="whoSelect"></select>
      <label>Ng√†y b·∫Øt ƒë·∫ßu:</label>
      <input type="date" id="startDateInput"/>
      <button id="saveStartBtn">L∆∞u ng√†y b·∫Øt ƒë·∫ßu</button>
    </div>
    <div id="startSummary" style="margin-top:8px"></div>
  </div>

  <!-- üèÜ Leaderboard -->
  <div class="panel" id="leaderboard"></div>

  <!-- üìä Bi·ªÉu ƒë·ªì -->
  <div class="panel">
    <canvas id="barChart" height="180"></canvas>
  </div>

  <!-- üìÖ B·∫£ng 30 ng√†y -->
  <div class="panel">
    <table id="daysTable"></table>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- üìù Modal nh·∫≠t k√Ω -->
<div id="journalModal">
  <form id="journalForm" onsubmit="saveJournal(event)">
    <h3>Nh·∫≠t k√Ω ng√†y <span id="journalDay"></span> - <span id="journalWho"></span></h3>
    <input type="number" id="weightInput" placeholder="C√¢n n·∫∑ng (kg)" step="0.1"/>
    <input type="number" id="waistInput" placeholder="V√≤ng eo (cm)" step="0.1"/>
    <textarea id="noteInput" rows="3" placeholder="T√¨nh tr·∫°ng s·ª©c kho·∫ª / ghi ch√∫"></textarea>
    <div class="actions">
      <button type="button" onclick="closeJournal()">ƒê√≥ng</button>
      <button type="submit">L∆∞u</button>
    </div>
  </form>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ================== FIREBASE CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyB9MISUTOozdHB5wQvQpNGARrCVM4qRIF0",
  authDomain: "ngay-bye-bye-mo-bung.firebaseapp.com",
  projectId: "ngay-bye-bye-mo-bung",
  storageBucket: "ngay-bye-bye-mo-bung.appspot.com",
  messagingSenderId: "568512660319",
  appId: "1:568512660319:web:28913b61e0a0b67598ecea",
  measurementId: "G-4NLDXQKW5Q"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const ROOM_ID = "main"; 
const docRef = () => db.collection("rooms").doc(ROOM_ID);

/* ================== STATE ================== */
const DAYS=30;
const COLOR_POOL = ['#ff8fab','#a5b4fc','#9adbb3','#ffd6a5','#fecdd3','#b7e4c7','#c7d2fe','#fbcfe8'];

function defaultMembers(){
  return [
    {id:"Huong",name:"H∆∞∆°ng",color:"#ff8fab"},
    {id:"Thuy", name:"Th√πy", color:"#a5b4fc"},
    {id:"Lien", name:"Li√™n",  color:"#9adbb3"},
  ];
}
function defaultState(){
  return {
    members: defaultMembers(),                   // ƒë·ªông
    days: Array.from({length:DAYS},()=>({})),    // m·ªói ng√†y: id -> bool
    startDate: {},                               // id -> YYYY-MM-DD
    journal: {},                                  // `${id}_${day}` -> {weight,waist,note}
    milestone: {}                                 // id -> {7:true,15:true,30:true}
  };
}
let state=defaultState();

/* kh·ªüi t·∫°o key cho days theo members */
function ensureDayKeys(){
  for(let d=0; d<DAYS; d++){
    state.members.forEach(m=>{
      if(typeof state.days[d][m.id] === 'undefined') state.days[d][m.id] = false;
    });
  }
}

/* ================== TOOLS ================== */
const toastEl=document.getElementById('toast');
function toast(msg,ms=2000){toastEl.textContent=msg;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),ms);}
function playDing(){try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator(),g=ctx.createGain();o.type="sine";o.frequency.value=880;g.gain.setValueAtTime(0.0001, ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.18);o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+0.2);}catch{}}
const confettiCanvas=document.getElementById('confetti');const cctx=confettiCanvas.getContext('2d');
function sizeCanvas(){confettiCanvas.width=innerWidth;confettiCanvas.height=innerHeight;}sizeCanvas();addEventListener('resize',sizeCanvas);
let particles=[];(function tick(){cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);particles.forEach(p=>{p.life--;p.x+=p.vx;p.vy+=0.18;p.y+=p.vy;p.rot+=p.spin;cctx.save();cctx.translate(p.x,p.y);cctx.rotate(p.rot);cctx.font=p.size+"px serif";cctx.fillText(p.emoji,0,0);cctx.restore();});particles=particles.filter(p=>p.life>0);requestAnimationFrame(tick);})();
function burst(x,y,emoji="üå∏"){for(let i=0;i<25;i++){particles.push({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()*-6)-2,rot:Math.random()*6,life:60,emoji,spin:(Math.random()-0.5)*0.3,size:18+Math.random()*10});}}
const MOTIVATION=["C·ªë l√™n!!! üí™","Tuy·ªát v·ªùi, b·∫°n l√†m ƒë∆∞·ª£c r·ªìi! üåü","Gi·ªØ v·ªØng phong ƒë·ªô nh√©! üî•","M·ªói ng√†y m·ªôt b∆∞·ªõc nh·ªè, b·∫°n ƒëang ti·∫øn b·ªô! üöÄ","B·∫°n m·∫°nh m·∫Ω h∆°n b·∫°n nghƒ©! üíñ"];
function randomMsg(){return MOTIVATION[Math.floor(Math.random()*MOTIVATION.length)];}
function slugify(s){return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]+/g,'').replace(/^\d+/,'').trim() || ('p'+Math.random().toString(36).slice(2,6));}

/* ================== FIRESTORE ================== */
function save(){docRef().set(state,{merge:true});}
function subscribeRealtime(){
  docRef().onSnapshot(snap=>{
    if(snap.exists){
      state = Object.assign(defaultState(), snap.data());
      ensureDayKeys();
      renderAll();
    }else{
      ensureDayKeys(); docRef().set(state);
    }
  }, _=>{ ensureDayKeys(); renderAll(); });
}

/* ================== JOURNAL ================== */
let currentDay=null,currentWho=null;
function openJournal(day,id){
  currentDay=day; currentWho=id;
  document.getElementById('journalDay').textContent=day+1;
  const m = state.members.find(x=>x.id===id);
  document.getElementById('journalWho').textContent = m? m.name : id;
  const key=`${id}_${day}`, j=state.journal[key]||{};
  document.getElementById('weightInput').value=j.weight||"";
  document.getElementById('waistInput').value=j.waist||"";
  document.getElementById('noteInput').value=j.note||"";
  document.getElementById('journalModal').style.display="flex";
}
function closeJournal(){document.getElementById('journalModal').style.display="none";}
function saveJournal(e){
  e.preventDefault();
  const key=`${currentWho}_${currentDay}`;
  state.journal[key]={
    weight:document.getElementById('weightInput').value,
    waist:document.getElementById('waistInput').value,
    note:document.getElementById('noteInput').value
  };
  save(); closeJournal(); renderTable(); toast("ƒê√£ l∆∞u nh·∫≠t k√Ω üìí");
}

/* ================== START, STREAK, MILESTONE, TOGGLE ================== */
function saveStart(){
  const who=document.getElementById('whoSelect').value;
  const date=document.getElementById('startDateInput').value;
  if(!who||!date) return toast("Ch·ªçn th√†nh vi√™n v√† ng√†y b·∫Øt ƒë·∫ßu!");
  state.startDate[who]=date; save(); renderStartSummary(); toast("ƒê√£ l∆∞u ng√†y b·∫Øt ƒë·∫ßu ‚úÖ");
}
function currentStreak(id){
  let s=0;
  for(let d=DAYS-1; d>=0; d--){
    if(state.days[d][id]) s++;
    else break;
  }
  return s;
}
function totalOf(id){return state.days.reduce((a,d)=>a+(d[id]?1:0),0);}
function checkMilestones(id){
  const t=totalOf(id);
  state.milestone[id]=state.milestone[id]||{};
  [7,15,30].forEach(m=>{
    if(t===m && !state.milestone[id][m]){
      state.milestone[id][m]=true; save();
      toast(`üéâ ${state.members.find(x=>x.id===id)?.name||id} ƒë·∫°t m·ªëc ${m} ng√†y!`, 3500);
      burst(innerWidth/2, innerHeight/2, "‚ú®");
    }
  });
}
function doToggle(day,id){
  const start=state.startDate[id];
  if(start){
    const startIdx=Math.floor((Date.now()-new Date(start).getTime())/(1000*60*60*24));
    if(day>startIdx) return toast("Ch∆∞a t·ªõi ng√†y n√†y!");
  }
  state.days[day][id]=!state.days[day][id];
  save(); burst(innerWidth/2, innerHeight/3,"üå∏"); playDing();
  const t=totalOf(id);
  if([7,15,30].includes(t)){ toast(`üéâ M·ªëc ${t} ng√†y!`); burst(innerWidth/2, innerHeight/2,"üéâ"); }
  else toast(randomMsg());
  checkMilestones(id);
  renderLeaderboard(); renderChart(); renderTable();
}

/* ================== MEMBER MGMT (ADD / EDIT / DELETE) ================== */
function renderMemberChips(){
  const box=document.getElementById('memberChips');
  box.innerHTML="";
  state.members.forEach(m=>{
    const chip=document.createElement('div');
    chip.className='chip';
    chip.innerHTML=`
      <span class="colordot" style="background:${m.color}"></span>
      <span class="name">${m.name}</span>
      <button title="ƒê·ªïi t√™n" aria-label="edit" onclick="editMember('${m.id}')">‚úé</button>
      <button title="Xo√°" aria-label="delete" onclick="deleteMember('${m.id}')">üóëÔ∏è</button>
    `;
    box.appendChild(chip);
  });
}
function editMember(id){
  const mem=state.members.find(x=>x.id===id);
  if(!mem) return;
  const newName=prompt("Nh·∫≠p t√™n m·ªõi:", mem.name);
  if(!newName) return;
  mem.name=newName.trim();
  save();
  renderMemberChips(); renderStartControls(); renderLeaderboard(); renderChart(); renderTable();
  toast("ƒê√£ ƒë·ªïi t√™n ‚úÖ");
}
function deleteMember(id){
  const mem=state.members.find(x=>x.id===id);
  if(!mem) return;
  if(state.members.length<=1){
    return toast("C·∫ßn √≠t nh·∫•t 1 th√†nh vi√™n.");
  }
  const ok = confirm(`Xo√° ${mem.name}? M·ªçi d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã xo√°.`);
  if(!ok) return;

  // 1) Xo√° kh·ªèi danh s√°ch members
  state.members = state.members.filter(m=>m.id!==id);

  // 2) Xo√° c·ªôt trong days
  for(let d=0; d<DAYS; d++){
    if(id in state.days[d]) delete state.days[d][id];
  }

  // 3) Xo√° startDate & milestone
  if(id in state.startDate) delete state.startDate[id];
  if(id in state.milestone) delete state.milestone[id];

  // 4) Xo√° m·ªçi journal c·ªßa id
  Object.keys(state.journal).forEach(k=>{
    if(k.startsWith(id+"_")) delete state.journal[k];
  });

  // 5) L∆∞u & render
  save();
  renderMemberChips(); renderStartControls(); renderStartSummary();
  renderLeaderboard(); renderChart(); renderTable();
  toast("ƒê√£ xo√° th√†nh vi√™n üóëÔ∏è");
}

/* ================== RENDER ================== */
let chart; // Chart.js instance

function renderStartControls(){
  const sel=document.getElementById('whoSelect');
  sel.innerHTML="";
  state.members.forEach(m=>{
    const op=document.createElement('option');
    op.value=m.id; op.textContent=m.name;
    sel.appendChild(op);
  });
}
function renderStartSummary(){
  const div=document.getElementById('startSummary');
  let html="";
  state.members.forEach(m=>{
    if(state.startDate[m.id]) html+=`${m.name}: b·∫Øt ƒë·∫ßu ${state.startDate[m.id]}<br>`;
  });
  div.innerHTML=html;
}
function renderLeaderboard(){
  let html="<h2>üèÜ Leaderboard</h2>";
  state.members.forEach(m=>{
    const total=totalOf(m.id);
    const streak=currentStreak(m.id);
    html+=`<div><b style="color:${m.color}">${m.name}</b>: ${total}/${DAYS} ng√†y ‚Ä¢ üî• ${streak} streak</div>`;
  });
  document.getElementById('leaderboard').innerHTML=html;
}
function renderChart(){
  const ctx=document.getElementById('barChart');
  const labels=state.members.map(m=>m.name);
  const data=state.members.map(m=>totalOf(m.id));
  const colors=state.members.map(m=>m.color||COLOR_POOL[0]);
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',
    data:{labels,datasets:[{data,backgroundColor:colors}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,suggestedMax:30}}}
  });
}
function renderTable(){
  const tableEl=document.getElementById('daysTable');
  const thead=document.createElement('thead');
  let headerRow=document.createElement('tr');
  headerRow.innerHTML="<th>Ng√†y</th>";
  state.members.forEach(m=>{headerRow.innerHTML+=`<th style="color:${m.color}">${m.name}</th>`;});
  thead.appendChild(headerRow);

  const tbody=document.createElement('tbody');
  for(let d=0; d<DAYS; d++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><b>${d+1}</b></td>`;
    state.members.forEach(m=>{
      const td=document.createElement('td');
      td.className="daycell"+(state.days[d][m.id]?" done":"");

      // n√∫t tick
      const tickSpan=document.createElement('span');
      tickSpan.textContent=state.days[d][m.id]?"‚úÖ":"‚Äî";
      tickSpan.style.marginRight="6px";
      tickSpan.onclick=()=>doToggle(d,m.id);
      td.appendChild(tickSpan);

      // n√∫t journal
      const noteBtn=document.createElement('button');
      noteBtn.textContent="üìù";
      noteBtn.title="Nh·∫≠t k√Ω";
      noteBtn.style.border="none";
      noteBtn.style.background="transparent";
      noteBtn.style.cursor="pointer";
      noteBtn.onclick=(e)=>{e.stopPropagation(); openJournal(d,m.id);};
      td.appendChild(noteBtn);

      td.ondblclick=()=>openJournal(d,m.id);

      const key=`${m.id}_${d}`;
      if(state.journal[key]){
        const tip=document.createElement('div');
        tip.className="tooltip";
        tip.textContent=`‚öñÔ∏è ${state.journal[key].weight||"-"}kg\nüìè ${state.journal[key].waist||"-"}cm\nüìù ${state.journal[key].note||""}`;
        td.appendChild(tip);
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  tableEl.innerHTML="";
  tableEl.appendChild(thead);
  tableEl.appendChild(tbody);
}
function renderAll(){
  renderMemberChips();
  renderStartControls();
  renderStartSummary();
  renderLeaderboard();
  renderChart();
  renderTable();
}

/* ================== EVENTS ================== */
document.getElementById('addMemberBtn').onclick=()=>{
  addMember();
};
document.getElementById('saveStartBtn').onclick=saveStart;

/* ================== BOOT ================== */
subscribeRealtime();
ensureDayKeys();
renderAll();
</script>
</body>
</html>
